<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfeatured</title>
</head>
<body>
    <div id="jellyfeaturedPage" data-role="page" class="page type-interior" data-require="emby-button,emby-input,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">Jellyfeatured Settings</h2>
                </div>
                
                <p class="settingsDescription">Configure how content recommendations appear on your home page.</p>
                
                <form id="jellyfeaturedConfigForm">
                    <div class="verticalSection">
                        <h3>Category Order</h3>
                        <div class="fieldDescription">
                            Change the order that content categories appear in the featured carousel.
                        </div>
                        
                        <div id="categoryList"></div>
                        
                        <button is="emby-button" type="button" id="btnResetOrder" class="raised button-alt" style="margin-top: 1em;">
                            Reset to Default Order
                        </button>
                    </div>
                    
                    <div class="verticalSection">
                        <h3>Refresh Settings</h3>
                        
                        <div class="inputContainer">
                            <label for="txtRefreshIntervalHours">Refresh Interval (hours)</label>
                            <input is="emby-input" type="number" id="txtRefreshIntervalHours" min="1" max="168" step="1" />
                            <div class="fieldDescription">
                                How often to refresh recommendations (1-168 hours). Default is 24 hours.
                            </div>
                        </div>
                        
                        <button is="emby-button" type="button" id="btnManualRefresh" class="raised button-alt" style="margin-top: 1em;">
                            Refresh Now
                        </button>
                    </div>
                    
                    <br>
                    <button is="emby-button" type="submit" class="raised button-submit">
                        Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var pluginId = "639b5171-918b-4b24-82e4-d35c10be63a4";
        
        var availableCategories = {
            "Latest Release": "Most recently released movie by premiere date",
            "Recently Added in Films": "Most recently added movie to your library", 
            "Recently Added in Series": "Most recently added series to your library",
            "Best Rated in Films": "Highest rated movie in your library",
            "Best Rated in Series": "Highest rated series in your library"
        };
        
        var defaultCategoryOrder = [
            "Latest Release",
            "Recently Added in Films", 
            "Recently Added in Series",
            "Best Rated in Films",
            "Best Rated in Series"
        ];
        
        var currentCategoryOrder = defaultCategoryOrder.slice();
        
        // Global functions for inline onclick handlers (required for Jellyfin 10.11.4)
        function moveCategoryUp(index) {
            if (index > 0) {
                var temp = currentCategoryOrder[index];
                currentCategoryOrder[index] = currentCategoryOrder[index - 1];
                currentCategoryOrder[index - 1] = temp;
                populateCategoryList();
            }
        }
        
        function moveCategoryDown(index) {
            if (index < currentCategoryOrder.length - 1) {
                var temp = currentCategoryOrder[index];
                currentCategoryOrder[index] = currentCategoryOrder[index + 1];
                currentCategoryOrder[index + 1] = temp;
                populateCategoryList();
            }
        }

        function loadConfiguration() {
            try {
                Dashboard.showLoadingMsg();
                
                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    var intervalInput = document.querySelector('#txtRefreshIntervalHours');
                    if (intervalInput) {
                        intervalInput.value = config.RefreshIntervalHours || 24;
                    }

                    currentCategoryOrder = config.CategoryOrder || defaultCategoryOrder;
                    populateCategoryList();
                    Dashboard.hideLoadingMsg();
                }).catch(function() {
                    Dashboard.hideLoadingMsg();
                    currentCategoryOrder = defaultCategoryOrder;
                    populateCategoryList();
                });
            } catch (e) {
                currentCategoryOrder = defaultCategoryOrder;
                populateCategoryList();
            }
        }
        
        function populateCategoryList() {
            var categoryList = document.getElementById('categoryList');
            if (!categoryList) return;
            
            categoryList.innerHTML = '';
            
            currentCategoryOrder.forEach(function(categoryName, index) {
                if (availableCategories[categoryName]) {
                    var categoryDiv = createCategoryItem(categoryName, index);
                    categoryList.appendChild(categoryDiv);
                }
            });
        }
        
        function createCategoryItem(categoryName, index) {
            var div = document.createElement('div');
            div.style.marginBottom = '1em';
            div.style.padding = '12px';
            div.style.border = '1px solid var(--theme-body-secondary-text-color, #999)';
            div.style.borderRadius = '6px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'space-between';
            div.style.backgroundColor = 'var(--theme-background-color-secondary, #f5f5f5)';
            
            var isFirst = index === 0;
            var isLast = index === currentCategoryOrder.length - 1;
            
            var upButton = isFirst ? 
                '<button type="button" disabled style="padding: 6px 12px; margin-right: 4px; opacity: 0.5;">↑</button>' :
                '<button type="button" onclick="moveCategoryUp(' + index + ')" style="padding: 6px 12px; margin-right: 4px; cursor: pointer; background: var(--accent-color, #007acc); color: white; border: none; border-radius: 3px;">↑</button>';
            
            var downButton = isLast ?
                '<button type="button" disabled style="padding: 6px 12px; opacity: 0.5;">↓</button>' :
                '<button type="button" onclick="moveCategoryDown(' + index + ')" style="padding: 6px 12px; cursor: pointer; background: var(--accent-color, #007acc); color: white; border: none; border-radius: 3px;">↓</button>';
            
            div.innerHTML = 
                '<div style="flex: 1;">' +
                    '<div style="font-weight: bold; color: var(--theme-body-text-color, #000);">' + escapeHtml(categoryName) + '</div>' +
                    '<div style="font-size: 0.9em; color: var(--theme-body-secondary-text-color, #666); margin-top: 4px;">' + escapeHtml(availableCategories[categoryName]) + '</div>' +
                '</div>' +
                '<div>' + upButton + downButton + '</div>';
            
            return div;
        }
        
        function resetCategoryOrder() {
            currentCategoryOrder = defaultCategoryOrder.slice();
            populateCategoryList();
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function saveConfiguration(e) {
            e.preventDefault();
            
            try {
                Dashboard.showLoadingMsg();

                var refreshInterval = parseInt(document.querySelector('#txtRefreshIntervalHours').value) || 24;
                if (refreshInterval < 1) refreshInterval = 1;
                if (refreshInterval > 168) refreshInterval = 168;

                var config = {
                    CategoryOrder: currentCategoryOrder,
                    RefreshIntervalHours: refreshInterval,
                    LastManualRefresh: 0
                };

                ApiClient.updatePluginConfiguration(pluginId, config).then(function () {
                    Dashboard.hideLoadingMsg();
                    if (Dashboard.alert) {
                        Dashboard.alert('Settings saved successfully!');
                    }
                }).catch(function() {
                    Dashboard.hideLoadingMsg();
                    if (Dashboard.alert) {
                        Dashboard.alert('Failed to save settings.');
                    }
                });
            } catch (e) {
                Dashboard.hideLoadingMsg();
            }
        }

        function manualRefresh() {
            try {
                var button = document.querySelector('#btnManualRefresh');
                button.disabled = true;
                button.textContent = 'Refreshing...';
                Dashboard.showLoadingMsg();
                
                var config = {
                    CategoryOrder: currentCategoryOrder,
                    RefreshIntervalHours: parseInt(document.querySelector('#txtRefreshIntervalHours').value) || 24,
                    LastManualRefresh: Date.now()
                };
                
                ApiClient.updatePluginConfiguration(pluginId, config).then(function() {
                    button.textContent = 'Refresh Now';
                    button.disabled = false;
                    Dashboard.hideLoadingMsg();
                    if (Dashboard.alert) {
                        Dashboard.alert('Recommendations refreshed!');
                    }
                }).catch(function() {
                    button.textContent = 'Refresh Now';
                    button.disabled = false;
                    Dashboard.hideLoadingMsg();
                    if (Dashboard.alert) {
                        Dashboard.alert('Failed to refresh.');
                    }
                });
            } catch (e) {
                // Handle error silently
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            populateCategoryList();
            loadConfiguration();
            
            var form = document.querySelector('#jellyfeaturedConfigForm');
            if (form) {
                form.addEventListener('submit', saveConfiguration);
            }
            
            var refreshBtn = document.querySelector('#btnManualRefresh');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', manualRefresh);
            }
            
            var resetBtn = document.querySelector('#btnResetOrder');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetCategoryOrder);
            }
        });

    </script>
</body>
</html>