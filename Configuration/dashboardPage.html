<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfeatured configuration</title>
</head>
<body>
    <div id="jellyfeaturedPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-button,emby-input,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">Jellyfeatured configuration</h2>
                </div>
                
                <p class="settingsDescription">Configure your featured section here. Changes take effect after saving.</p>
                
                <form id="jellyfeaturedConfigForm">
                    <div class="verticalSection">
                        <h3>Featured categories order</h3>
                        <div class="fieldDescription">
                            Rearrange the order in which the featured items appear.
                        </div>
                        
                        <div id="categoryOrderList" style="margin-top: 20px;">
                            <!-- Categories will be populated here -->
                        </div>
                        
                        <button is="emby-button" type="button" id="btnResetOrder" class="raised button-alt" style="margin-top: 1em;">
                            Reset to Default Order
                        </button>
                    </div>

                    <div class="verticalSection">
                        <h3>Refresh settings</h3>
                        <div class="fieldDescription">
                            Control how often the featured section updates.
                        </div>
                        
                        <div class="inputContainer" style="margin-top: 15px;">
                            <label class="inputLabel" for="refreshInterval">
                                Automatic Refresh Interval
                            </label>
                            <select is="emby-select" id="refreshInterval">
                                <option value="24">Daily</option>
                                <option value="168">Weekly</option>
                                <option value="336">Biweekly</option>
                                <option value="720">Monthly</option>
                            </select>
                        </div>
                        
                        <button is="emby-button" type="button" id="btnManualRefresh" class="raised button-alt" style="margin-top: 1em;">
                            Manual refresh
                        </button>
                    </div>
                    
                    <div style="margin-top: 2em; padding-top: 2em; border-top: 1px solid rgba(255,255,255,0.15);">
                        <button is="emby-button" type="button" id="btnSaveSettings" class="raised submit">
                            Save Configuration
                        </button>
                        
                        <button is="emby-button" type="button" id="btnCancelSettings" class="raised button-cancel" style="margin-left: 1em;">
                            Cancel
                        </button>
                        
                        <div id="configMessage" style="margin-top: 1em; color: #52b54b; display: none;">
                            Settings saved successfully and applied to carousel.
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .categoryItem {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #52b54b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .categoryItem:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .categoryInfo {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .categoryName {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .categoryDescription {
            font-size: 0.85em;
            opacity: 0.7;
        }
        
        .categoryControls {
            display: flex;
            gap: 5px;
        }
        
        .moveButton {
            width: 32px;
            height: 32px;
            min-width: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        
        .moveButton:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
        }
        
        .moveButton:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .positionNumber {
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>

    <script type="text/javascript">
        (function() {
            let currentConfig = null;
            const categories = [
                { id: 'latestRelease', name: 'Latest Movie Release', description: 'Most recently released movie by premiere date' },
                { id: 'recentFilms', name: 'New Movies in Library', description: 'Most recently added movies to your library' },
                { id: 'recentSeries', name: 'New TV Shows in Library', description: 'Most recently added TV series to your library' },
                { id: 'bestFilms', name: 'Top Rated Movies', description: 'Highest rated movies in your library' },
                { id: 'bestSeries', name: 'Top Rated TV Shows', description: 'Highest rated TV shows in your library' }
            ];

            function loadConfiguration() {
                ApiClient.getPluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84').then(function(config) {
                    currentConfig = config || {};
                    
                    if (!currentConfig.CategoryOrder || currentConfig.CategoryOrder.length === 0) {
                        currentConfig.CategoryOrder = [
                            { CategoryId: 'latestRelease', Priority: 1 },
                            { CategoryId: 'recentFilms', Priority: 2 },
                            { CategoryId: 'recentSeries', Priority: 3 },
                            { CategoryId: 'bestFilms', Priority: 4 },
                            { CategoryId: 'bestSeries', Priority: 5 }
                        ];
                    }
                    
                    if (!currentConfig.RefreshIntervalHours) {
                        currentConfig.RefreshIntervalHours = 24; // Default to daily
                    }
                    
                    renderCategoryList();
                    document.getElementById('refreshInterval').value = currentConfig.RefreshIntervalHours;
                });
            }

            function renderCategoryList() {
                const container = document.getElementById('categoryOrderList');
                
                // Sort categories by their current priority
                const sortedCategories = [...categories].sort((a, b) => {
                    const aPriority = getCurrentPriority(a.id);
                    const bPriority = getCurrentPriority(b.id);
                    return aPriority - bPriority;
                });
                
                container.innerHTML = '';
                
                sortedCategories.forEach((category, index) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'categoryItem';
                    categoryDiv.dataset.categoryId = category.id;
                    
                    const positionDiv = document.createElement('div');
                    positionDiv.className = 'positionNumber';
                    positionDiv.textContent = index + 1;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'categoryInfo';
                    infoDiv.innerHTML = `
                        <div class="categoryName">${category.name}</div>
                        <div class="categoryDescription">${category.description}</div>
                    `;
                    
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'categoryControls';
                    
                    // Create up button
                    const upButton = document.createElement('button');
                    upButton.className = 'raised moveButton';
                    upButton.textContent = '↑';
                    upButton.disabled = index === 0;
                    upButton.addEventListener('click', () => moveCategory(category.id, -1));
                    
                    // Create down button
                    const downButton = document.createElement('button');
                    downButton.className = 'raised moveButton';
                    downButton.textContent = '↓';
                    downButton.disabled = index === sortedCategories.length - 1;
                    downButton.addEventListener('click', () => moveCategory(category.id, 1));
                    
                    controlsDiv.appendChild(upButton);
                    controlsDiv.appendChild(downButton);
                    
                    categoryDiv.appendChild(positionDiv);
                    categoryDiv.appendChild(infoDiv);
                    categoryDiv.appendChild(controlsDiv);
                    
                    container.appendChild(categoryDiv);
                });
            }

            function getCurrentPriority(categoryId) {
                const categoryOrder = currentConfig.CategoryOrder.find(c => c.CategoryId === categoryId);
                return categoryOrder ? categoryOrder.Priority : 999;
            }

            function moveCategory(categoryId, direction) {
                const categoryIndex = currentConfig.CategoryOrder.findIndex(c => c.CategoryId === categoryId);
                if (categoryIndex === -1) return;
                
                const currentPriority = currentConfig.CategoryOrder[categoryIndex].Priority;
                const newPriority = currentPriority + direction;
                
                // Check bounds
                if (newPriority < 1 || newPriority > categories.length) return;
                
                // Find the category that currently has the target priority
                const targetIndex = currentConfig.CategoryOrder.findIndex(c => c.Priority === newPriority);
                
                if (targetIndex !== -1) {
                    // Swap priorities
                    currentConfig.CategoryOrder[targetIndex].Priority = currentPriority;
                    currentConfig.CategoryOrder[categoryIndex].Priority = newPriority;
                    
                    renderCategoryList();
                }
            }

            function resetOrder() {
                currentConfig.CategoryOrder = [
                    { CategoryId: 'latestRelease', Priority: 1 },
                    { CategoryId: 'recentFilms', Priority: 2 },
                    { CategoryId: 'recentSeries', Priority: 3 },
                    { CategoryId: 'bestFilms', Priority: 4 },
                    { CategoryId: 'bestSeries', Priority: 5 }
                ];
                renderCategoryList();
            }

            function saveConfiguration() {
                currentConfig.RefreshIntervalHours = parseInt(document.getElementById('refreshInterval').value);
                currentConfig.LastManualRefresh = new Date().toISOString();
                
                ApiClient.updatePluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84', currentConfig).then(function() {
                    const messageEl = document.getElementById('configMessage');
                    messageEl.style.display = 'block';
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 3000);
                });
            }

            function manualRefresh() {
                currentConfig.LastManualRefresh = new Date().toISOString();
                
                ApiClient.updatePluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84', currentConfig).then(function() {
                    const messageEl = document.getElementById('configMessage');
                    messageEl.textContent = 'Carousel refreshed successfully.';
                    messageEl.style.display = 'block';
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                        messageEl.textContent = 'Settings saved successfully and applied to carousel.';
                    }, 3000);
                });
            }

            document.getElementById('btnResetOrder').addEventListener('click', resetOrder);
            document.getElementById('btnSaveSettings').addEventListener('click', saveConfiguration);
            document.getElementById('btnManualRefresh').addEventListener('click', manualRefresh);
            
            document.getElementById('btnCancelSettings').addEventListener('click', function() {
                window.history.back();
            });

            // Load configuration on page load
            loadConfiguration();
        })();
    </script>
</body>
</html>