<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfeatured configuration</title>
</head>
<body>
    <div id="jellyfeaturedPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-button,emby-input,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">Jellyfeatured configuration</h2>
                </div>
                
                <p class="settingsDescription">Configure your featured section by editing the JSON configuration directly.</p>
                
                <form id="jellyfeaturedConfigForm">
                    <div class="verticalSection">
                        <h3>Plugin Configuration</h3>
                        <div class="fieldDescription">
                            Edit the complete JSON configuration below. Changes take effect immediately after saving.
                        </div>
                        
                        <div class="inputContainer" style="margin-top: 15px;">
                            <label class="inputLabel" for="jsonEditor">
                                Configuration (JSON)
                            </label>
                            <textarea is="emby-textarea" id="jsonEditor" rows="20" style="width: 100%; font-family: monospace; font-size: 12px;"></textarea>
                            <div class="fieldDescription">
                                • <strong>CategoryOrder</strong>: Array of category variables determining carousel order<br>
                                • <strong>RefreshIntervalHours</strong>: Number (24=daily, 168=weekly, 336=biweekly, 720=monthly)<br>
                                • <strong>EnableAdminPicks</strong>: Boolean (true/false)<br>
                                • <strong>AdminPickIds</strong>: Array of Jellyfin media item UUIDs (can be empty)<br><br>
                                <strong>Available Category Variables:</strong><br>
                                • <code>featuredPick</code> - Admin's Pick (requires EnableAdminPicks: true)<br>
                                • <code>latestRelease</code> - Latest Movie Release<br>
                                • <code>recentlyAddedFilms</code> - Recently Added Films<br>
                                • <code>recentlyAddedSeries</code> - Recently Added Series<br>
                                • <code>bestRatedFilms</code> - Best Rated Films<br>
                                • <code>bestRatedSeries</code> - Best Rated Series
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5em;">
                            <button is="emby-button" type="button" id="btnSaveJson" class="raised submit" style="margin-right: 0.5em;">
                                Save Configuration
                            </button>
                            
                            <button is="emby-button" type="button" id="btnReloadJson" class="raised button-alt" style="margin-right: 0.5em;">
                                Reload from Server
                            </button>
                            
                            <button is="emby-button" type="button" id="btnManualRefresh" class="raised button-alt">
                                Refresh Carousel Now
                            </button>
                        </div>
                        
                        <div id="configMessage" style="margin-top: 1em; display: none;">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .categoryItem {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #52b54b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .categoryItem:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .categoryInfo {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .categoryName {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .categoryDescription {
            font-size: 0.85em;
            opacity: 0.7;
        }
        
        .positionNumber {
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>

    <script type="text/javascript">
        (function() {
            let currentConfig = null;

            function loadConfiguration() {
                ApiClient.getPluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84').then(function(config) {
                    currentConfig = config || {};
                    
                    // Set defaults if not present
                    if (!currentConfig.CategoryOrder || currentConfig.CategoryOrder.length === 0) {
                        currentConfig.CategoryOrder = [
                            "latestRelease",
                            "recentlyAddedFilms",
                            "recentlyAddedSeries",
                            "bestRatedFilms",
                            "bestRatedSeries"
                        ];
                    }
                    
                    if (!currentConfig.RefreshIntervalHours) {
                        currentConfig.RefreshIntervalHours = 24;
                    }
                    
                    if (!currentConfig.AdminPickIds) {
                        currentConfig.AdminPickIds = [];
                    }
                    
                    if (currentConfig.EnableAdminPicks === undefined) {
                        currentConfig.EnableAdminPicks = false;
                    }
                    
                    // Load current config into JSON editor
                    loadJsonEditor();
                }).catch(function(error) {
                    showMessage('Failed to load configuration: ' + error.message, true);
                    // Load defaults into editor on error
                    currentConfig = {
                        "CategoryOrder": [
                            "latestRelease",
                            "recentlyAddedFilms",
                            "recentlyAddedSeries",
                            "bestRatedFilms",
                            "bestRatedSeries"
                        ],
                        "RefreshIntervalHours": 24,
                        "AdminPickIds": [],
                        "EnableAdminPicks": false
                    };
                    loadJsonEditor();
                });
            }

            function loadJsonEditor() {
                const jsonEditor = document.getElementById('jsonEditor');
                jsonEditor.value = JSON.stringify(currentConfig, null, 2);
            }

            function showMessage(message, isError = false) {
                const messageEl = document.getElementById('configMessage');
                messageEl.textContent = message;
                messageEl.style.color = isError ? '#ff6b6b' : '#52b54b';
                messageEl.style.display = 'block';
                messageEl.style.padding = '10px';
                messageEl.style.backgroundColor = isError ? 'rgba(255, 107, 107, 0.1)' : 'rgba(82, 181, 75, 0.1)';
                messageEl.style.border = isError ? '1px solid rgba(255, 107, 107, 0.3)' : '1px solid rgba(82, 181, 75, 0.3)';
                messageEl.style.borderRadius = '4px';
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 4000);
            }

            function reloadFromServer() {
                loadConfiguration();
                showMessage('Configuration reloaded from server. The editor now shows the current settings.');
            }

            function saveJsonFromEditor() {
                try {
                    const jsonEditor = document.getElementById('jsonEditor');
                    const newConfig = JSON.parse(jsonEditor.value);
                    
                    // Basic validation
                    if (!newConfig.CategoryOrder || !Array.isArray(newConfig.CategoryOrder)) {
                        throw new Error('CategoryOrder must be an array of strings');
                    }
                    
                    if (!newConfig.RefreshIntervalHours || typeof newConfig.RefreshIntervalHours !== 'number') {
                        throw new Error('RefreshIntervalHours must be a number');
                    }
                    
                    // Update current config
                    currentConfig = newConfig;
                    currentConfig.LastManualRefresh = new Date().toISOString();
                    
                    // Save to server
                    ApiClient.updatePluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84', currentConfig).then(function() {
                        showMessage('Configuration saved successfully! Changes have been applied to your carousel.');
                    }).catch(function(error) {
                        showMessage('Failed to save configuration: ' + error.message, true);
                    });
                    
                } catch (error) {
                    showMessage('Invalid JSON: ' + error.message, true);
                }
            }

            function manualRefresh() {
                if (!currentConfig) return;
                
                currentConfig.LastManualRefresh = new Date().toISOString();
                
                ApiClient.updatePluginConfiguration('7ebedd0b-a88c-4b1c-aa2c-4e8bbb82df84', currentConfig).then(function() {
                    showMessage('Featured section refreshed successfully! New recommendations are now active.');
                }).catch(function(error) {
                    showMessage('Failed to refresh featured section: ' + error.message, true);
                });
            }

            // Event listeners
            document.getElementById('btnSaveJson').addEventListener('click', saveJsonFromEditor);
            document.getElementById('btnReloadJson').addEventListener('click', reloadFromServer);
            document.getElementById('btnManualRefresh').addEventListener('click', manualRefresh);

            // Load configuration on page load
            loadConfiguration();
        })();
    </script>
</body>
</html>