<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfeatured</title>
</head>
<body>
    <div id="jellyfeaturedPage" data-role="page" class="page type-interior" data-require="emby-button,emby-input,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">Jellyfeatured Settings</h2>
                </div>
                
                <p class="settingsDescription">Configure how content recommendations appear on your home page.</p>
                
                <form id="jellyfeaturedConfigForm">
                    
                    <div class="verticalSection">
                        <h3>Category Order</h3>
                        <div class="fieldDescription">
                            Change the order that content categories appear in the featured carousel.
                        </div>
                        
                        <div id="categoryList"></div>
                        
                        <button is="emby-button" type="button" id="btnResetOrder" class="raised button-alt" style="margin-top: 1em;">
                            Reset to Default Order
                        </button>
                    </div>
                    
                    <div class="verticalSection">
                        <h3>Refresh Settings</h3>
                        
                        <div class="inputContainer">
                            <label for="txtRefreshIntervalHours">Refresh Interval (hours)</label>
                            <input is="emby-input" type="number" id="txtRefreshIntervalHours" min="1" max="168" step="1" />
                            <div class="fieldDescription">
                                How often to refresh recommendations (1-168 hours). Default is 24 hours.
                            </div>
                        </div>
                        
                        <button is="emby-button" type="button" id="btnManualRefresh" class="raised button-alt" style="margin-top: 1em;">
                            Refresh Now
                        </button>
                    </div>
                    
                    <br>
                    <button is="emby-button" type="submit" class="raised button-submit">
                        Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var pluginId = "639b5171-918b-4b24-82e4-d35c10be63a4";
        
        var availableCategories = {
            "Latest Release": "Most recently released movie by premiere date",
            "Recently Added in Films": "Most recently added movie to your library", 
            "Recently Added in Series": "Most recently added series to your library",
            "Best Rated in Films": "Highest rated movie in your library",
            "Best Rated in Series": "Highest rated series in your library"
        };
        
        var defaultCategoryOrder = [
            "Latest Release",
            "Recently Added in Films", 
            "Recently Added in Series",
            "Best Rated in Films",
            "Best Rated in Series"
        ];
        
        var currentCategoryOrder = defaultCategoryOrder.slice(); // Copy the default array
        
        // Global functions for inline onclick handlers
        function moveCategoryUp(index) {
            if (index > 0) {
                var temp = currentCategoryOrder[index];
                currentCategoryOrder[index] = currentCategoryOrder[index - 1];
                currentCategoryOrder[index - 1] = temp;
                populateCategoryList();
            }
        }
        
        function moveCategoryDown(index) {
            if (index < currentCategoryOrder.length - 1) {
                var temp = currentCategoryOrder[index];
                currentCategoryOrder[index] = currentCategoryOrder[index + 1];
                currentCategoryOrder[index + 1] = temp;
                populateCategoryList();
            }
        }

        (function () {

            function loadConfiguration() {
                Dashboard.showLoadingMsg();
                
                ApiClient.getPluginConfiguration(pluginId).then(function (config) {

                    var intervalInput = document.querySelector('#txtRefreshIntervalHours');
                    
                    if (intervalInput) {
                        intervalInput.value = config.RefreshIntervalHours || 24;
                    } else {
                        // Could not find refresh interval input
                    }

                    currentCategoryOrder = config.CategoryOrder || defaultCategoryOrder;
                    populateCategoryList();
                    
                    Dashboard.hideLoadingMsg();
                    
                }).catch(function(error) {
                    Dashboard.hideLoadingMsg();
                    
                    var errorMsg = 'Failed to load configuration.';
                    if (error && error.message) {
                        errorMsg += ' Error: ' + error.message;
                    }
                    
                    if (Dashboard.alert) {
                        Dashboard.alert(errorMsg);
                    } else {
                        alert(errorMsg);
                    }

                    currentCategoryOrder = defaultCategoryOrder;
                    populateCategoryList();
                });
            }
            
            function populateCategoryList() {
                var categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';
                
                currentCategoryOrder.forEach(function(categoryName, index) {
                    if (availableCategories[categoryName]) {
                        var categoryDiv = createCategoryItem(categoryName, index);
                        categoryList.appendChild(categoryDiv);
                    }
                });
            }
            
            function createCategoryItem(categoryName, index) {
                var div = document.createElement('div');
                div.className = 'inputContainer';
                div.style.marginBottom = '1em';
                
                var isFirst = index === 0;
                var isLast = index === currentCategoryOrder.length - 1;
                
                var upButtonHtml = isFirst ? 
                    '<button type="button" disabled style="padding: 4px 8px; margin-right: 4px; background: #ccc; color: #666;">↑</button>' :
                    '<button type="button" onclick="moveCategoryUp(' + index + ')" style="padding: 4px 8px; margin-right: 4px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 3px;">↑</button>';
                
                var downButtonHtml = isLast ?
                    '<button type="button" disabled style="padding: 4px 8px; background: #ccc; color: #666;">↓</button>' :
                    '<button type="button" onclick="moveCategoryDown(' + index + ')" style="padding: 4px 8px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 3px;">↓</button>';
                
                div.innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #f5f5f5;">' +
                        '<div style="flex: 1;">' +
                            '<div style="font-weight: bold; color: #333;">' + escapeHtml(categoryName) + '</div>' +
                            '<div style="font-size: 0.9em; color: #666; margin-top: 4px;">' + escapeHtml(availableCategories[categoryName]) + '</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 4px; margin-left: 12px;">' +
                            upButtonHtml +
                            downButtonHtml +
                        '</div>' +
                    '</div>';
                
                return div;
            }
            
            function resetCategoryOrder() {
                currentCategoryOrder = [...defaultCategoryOrder];
                populateCategoryList();
            }
            
            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function saveConfiguration(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();

                var refreshInterval = parseInt(document.querySelector('#txtRefreshIntervalHours').value) || 24;
                if (refreshInterval < 1) refreshInterval = 1;
                if (refreshInterval > 168) refreshInterval = 168;

                var config = {
                    CategoryOrder: currentCategoryOrder,
                    RefreshIntervalHours: refreshInterval,
                    LastManualRefresh: 0
                };

                ApiClient.updatePluginConfiguration(pluginId, config).then(function (result) {
                    Dashboard.hideLoadingMsg();

                    if (Dashboard.alert) {
                        Dashboard.alert('Settings saved successfully!');
                    } else {
                        alert('Settings saved successfully!');
                    }

                    setTimeout(loadConfiguration, 500);
                    
                }).catch(function(error) {
                    Dashboard.hideLoadingMsg();
                    
                    var errorMsg = 'Failed to save settings.';
                    if (error && error.message) {
                        errorMsg += ' Error: ' + error.message;
                    }
                    
                    if (Dashboard.alert) {
                        Dashboard.alert(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                });
            }

            function manualRefresh() {
                var button = document.querySelector('#btnManualRefresh');
                var originalText = button.querySelector('span').innerText;
                
                button.disabled = true;
                button.querySelector('span').innerText = 'Refreshing...';
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                    console.log('Current config before manual refresh:', config);

                    config.CategoryOrder = currentCategoryOrder;
                    config.RefreshIntervalHours = parseInt(document.querySelector('#txtRefreshIntervalHours').value) || 24;
                    config.LastManualRefresh = Date.now();
                    
                    console.log('Updated config for manual refresh:', config);

                    return ApiClient.updatePluginConfiguration(pluginId, config);
                }).then(function() {
                    Dashboard.alert('Recommendations refresh triggered successfully!');
                }).catch(function(error) {
                    Dashboard.alert('Failed to trigger recommendations refresh. Please try again.');
                }).finally(function() {
                    button.disabled = false;
                    button.querySelector('span').innerText = originalText;
                    Dashboard.hideLoadingMsg();
                });
            }

            document.addEventListener('DOMContentLoaded', function () {
                // Initialize category list immediately with defaults
                populateCategoryList();
                
                loadConfiguration();
                document.querySelector('#jellyfeaturedConfigForm').addEventListener('submit', saveConfiguration);
                document.querySelector('#btnManualRefresh').addEventListener('click', manualRefresh);
                document.querySelector('#btnResetOrder').addEventListener('click', resetCategoryOrder);
            });
        })();
    </script>
</body>
</html>